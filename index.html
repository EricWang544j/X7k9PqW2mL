<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>酪梨銷售管理系統</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
        body {
            background-color: #f8f9fa;
            padding-top: 20px;
            padding-bottom: 40px;
        }
        .container {
            max-width: 1200px;
        }
        .card {
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            margin-bottom: 20px;
        }
        .card-header {
            background-color: #198754;
            color: white;
            font-weight: bold;
        }
        .table-responsive {
            max-height: 600px;
            overflow-y: auto;
        }
        .btn-group-sm {
            gap: 5px;
        }
        .spinner-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        .spinner-overlay.show {
            display: flex;
        }
        .required-mark {
            color: red;
        }
        .action-buttons {
            white-space: nowrap;
        }
        @media (max-width: 768px) {
            .table {
                font-size: 0.875rem;
            }
            .btn-sm {
                font-size: 0.75rem;
                padding: 0.25rem 0.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Spinner -->
    <div class="spinner-overlay" id="loadingSpinner">
        <div class="spinner-border text-light" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">載入中...</span>
        </div>
    </div>

    <div class="container">
        <!-- 標題 -->
        <div class="text-center mb-4">
            <h1 class="display-5"><i class="bi bi-egg"></i> 酪梨銷售管理系統</h1>
            <p class="text-muted">輕鬆管理您的酪梨銷售記錄</p>
        </div>

        <!-- 表單卡片 -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-plus-circle"></i> <span id="formTitle">新增銷售記錄</span>
            </div>
            <div class="card-body">
                <form id="saleForm">
                    <input type="hidden" id="recordId" value="">
                    <input type="hidden" id="rowIndex" value="">
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="customerName" class="form-label">賣給誰 <span class="required-mark">*</span></label>
                            <input type="text" class="form-control" id="customerName" required placeholder="請輸入客戶名稱">
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="saleDate" class="form-label">賣出日期 <span class="required-mark">*</span></label>
                            <input type="date" class="form-control" id="saleDate" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="totalAmount" class="form-label">實際賣出多少錢 <span class="required-mark">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="totalAmount" required placeholder="0" min="0">
                            </div>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="avocadoCount" class="form-label">幾個酪梨 <span class="required-mark">*</span></label>
                            <input type="number" class="form-control" id="avocadoCount" required placeholder="0" min="0">
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="seedlingCount" class="form-label">賣出幾棵酪梨苗</label>
                            <input type="number" class="form-control" id="seedlingCount" placeholder="0" min="0">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="largeBoxCount" class="form-label">大箱的幾箱？</label>
                            <input type="number" class="form-control" id="largeBoxCount" placeholder="0" min="0">
                        </div>
                        
                        <div class="col-md-3 mb-3">
                            <label for="smallBoxCount" class="form-label">小箱的幾箱？</label>
                            <input type="number" class="form-control" id="smallBoxCount" placeholder="0" min="0" >
                        </div>
                        
                        <div class="col-md-3 mb-3">
                            <label for="shippingCost" class="form-label">宅配費用？</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="shippingCost" placeholder="0" min="0" >
                            </div>
                        </div>
                        
                        <div class="col-md-3 mb-3">
                            <label for="pricePerJin" class="form-label">一斤多少？</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="pricePerJin" placeholder="0" min="0" >
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2 justify-content-end">
                        <button type="button" class="btn btn-secondary" id="cancelBtn" style="display: none;">
                            <i class="bi bi-x-circle"></i> 取消
                        </button>
                        <button type="submit" class="btn btn-success" id="submitBtn">
                            <i class="bi bi-check-circle"></i> 儲存
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 資料列表卡片 -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-table"></i> 銷售記錄列表</span>
                <button class="btn btn-sm btn-light" id="refreshBtn">
                    <i class="bi bi-arrow-clockwise"></i> 重新整理
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle">
                        <thead class="table-success">
                            <tr>
                                <th>賣給誰</th>
                                <th>賣出日期</th>
                                <th>金額</th>
                                <th>數量</th>
                                <th>酪梨苗</th>
                                <th>大箱</th>
                                <th>小箱</th>
                                <th>宅配費用</th>
                                <th>一斤多少</th>
                                <th class="text-center">操作</th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody">
                            <tr>
                                <td colspan="10" class="text-center text-muted">
                                    <div class="spinner-border spinner-border-sm" role="status">
                                        <span class="visually-hidden">載入中...</span>
                                    </div>
                                    載入資料中...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div id="noDataMessage" class="text-center text-muted py-3" style="display: none;">
                    <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                    <p>目前沒有任何銷售記錄</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="init.js"></script>

    <script>
        // Google Apps Script Web App URL
        // 請部署 Google Apps Script 後，將 Web App URL 填入下方
        //const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx_UghUuOFYhfbjFfXD75HEYipl-ryH-X-X23utheUdOcFZ1NjIxnzNyh27lDftquRx/exec';
        
        let editMode = false;
        let currentEditRow = null;

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            setupEventListeners();
            setDefaultDate();
        });

        // 設定預設日期為今天
        function setDefaultDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('saleDate').value = today;
        }

        // 設定事件監聽器
        function setupEventListeners() {
            document.getElementById('saleForm').addEventListener('submit', handleSubmit);
            document.getElementById('cancelBtn').addEventListener('click', resetForm);
            document.getElementById('refreshBtn').addEventListener('click', loadData);
        }

        // 載入資料
        function loadData() {
            showLoading(true);
            
            // 如果還沒設定 SCRIPT_URL，顯示提示訊息
            if (SCRIPT_URL === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE') {
                showLoading(false);
                displayData([]);
                showAlert('請先設定 Google Apps Script Web App URL', 'warning');
                return;
            }
            
            fetch(SCRIPT_URL + '?action=read')
                .then(response => response.json())
                .then(data => {
                    showLoading(false);
                    if (data.status === 'success') {
                        displayData(data.data);
                    } else {
                        showAlert('載入資料失敗：' + data.message, 'danger');
                    }
                })
                .catch(error => {
                    showLoading(false);
                    console.error('Error:', error);
                    showAlert('載入資料時發生錯誤', 'danger');
                    displayData([]);
                });
        }

        // 顯示資料
        function displayData(data) {
            const tbody = document.getElementById('dataTableBody');
            const noDataMsg = document.getElementById('noDataMessage');
            
            if (data.length === 0) {
                tbody.innerHTML = '';
                noDataMsg.style.display = 'block';
                return;
            }
            
            noDataMsg.style.display = 'none';
            
            // 反轉資料陣列，讓最新的資料顯示在最前面
            const reversedData = data.slice().reverse();
            
            tbody.innerHTML = reversedData.map((row, displayIndex) => {
                // 計算實際的資料索引（因為顯示順序是反轉的）
                const actualIndex = data.length - 1 - displayIndex;
                return `
                <tr>
                    <td>${escapeHtml(row.customerName || '')}</td>
                    <td>${row.saleDate || ''}</td>
                    <td>$${formatNumber(row.totalAmount)}</td>
                    <td>${row.avocadoCount || 0}</td>
                    <td>${row.seedlingCount || 0}</td>
                    <td>${row.largeBoxCount || 0}</td>
                    <td>${row.smallBoxCount || 0}</td>
                    <td>$${formatNumber(row.shippingCost)}</td>
                    <td>$${formatNumber(row.pricePerJin)}</td>
                    <td class="text-center action-buttons">
                        <button class="btn btn-sm btn-primary" onclick="editRecord(${actualIndex})">
                            <i class="bi bi-pencil"></i> 編輯
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteRecord(${actualIndex})">
                            <i class="bi bi-trash"></i> 刪除
                        </button>
                    </td>
                </tr>
                `;
            }).join('');
        }

        // 處理表單提交
        function handleSubmit(e) {
            e.preventDefault();
            
            const formData = {
                customerName: document.getElementById('customerName').value,
                saleDate: document.getElementById('saleDate').value,
                totalAmount: parseFloat(document.getElementById('totalAmount').value) || 0,
                avocadoCount: parseInt(document.getElementById('avocadoCount').value) || 0,
                seedlingCount: parseInt(document.getElementById('seedlingCount').value) || 0,
                largeBoxCount: parseInt(document.getElementById('largeBoxCount').value) || 0,
                smallBoxCount: parseInt(document.getElementById('smallBoxCount').value) || 0,
                shippingCost: parseFloat(document.getElementById('shippingCost').value) || 0,
                pricePerJin: parseFloat(document.getElementById('pricePerJin').value) || 0
            };

            if (editMode) {
                formData.rowIndex = currentEditRow;
                updateRecord(formData);
            } else {
                createRecord(formData);
            }
        }

        // 新增記錄
        function createRecord(data) {
            showLoading(true);
            
            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'create', data: data })
            })
            .then(response => response.json())
            .then(result => {
                showLoading(false);
                if (result.status === 'success') {
                    showAlert('新增成功！', 'success');
                    resetForm();
                    loadData();
                } else {
                    showAlert('新增失敗：' + result.message, 'danger');
                }
            })
            .catch(error => {
                showLoading(false);
                console.error('Error:', error);
                showAlert('新增時發生錯誤', 'danger');
            });
        }

        // 更新記錄
        function updateRecord(data) {
            showLoading(true);
            
            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'update', data: data })
            })
            .then(response => response.json())
            .then(result => {
                showLoading(false);
                if (result.status === 'success') {
                    showAlert('更新成功！', 'success');
                    resetForm();
                    loadData();
                } else {
                    showAlert('更新失敗：' + result.message, 'danger');
                }
            })
            .catch(error => {
                showLoading(false);
                console.error('Error:', error);
                showAlert('更新時發生錯誤', 'danger');
            });
        }

        // 編輯記錄
        function editRecord(index) {
            showLoading(true);

            fetch(SCRIPT_URL + '?action=read')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success' && data.data[index]) {
                        const record = data.data[index];
                        
                        document.getElementById('customerName').value = record.customerName || '';
                        document.getElementById('saleDate').value = record.saleDate || '';
                        document.getElementById('totalAmount').value = record.totalAmount || 0;
                        document.getElementById('avocadoCount').value = record.avocadoCount || 0;
                        document.getElementById('seedlingCount').value = record.seedlingCount || 0;
                        document.getElementById('largeBoxCount').value = record.largeBoxCount || 0;
                        document.getElementById('smallBoxCount').value = record.smallBoxCount || 0;
                        document.getElementById('shippingCost').value = record.shippingCost || 0;
                        document.getElementById('pricePerJin').value = record.pricePerJin || 0;
                        
                        editMode = true;
                        currentEditRow = index;
                        
                        document.getElementById('formTitle').textContent = '編輯銷售記錄';
                        document.getElementById('submitBtn').innerHTML = '<i class="bi bi-check-circle"></i> 更新';
                        document.getElementById('cancelBtn').style.display = 'inline-block';
                        
                        // 滾動到表單
                        document.getElementById('saleForm').scrollIntoView({ behavior: 'smooth' });

                         showLoading(false);

                    }
                })
                .catch(error => {
                     showLoading(false);
                    console.error('Error:', error);
                    showAlert('載入編輯資料時發生錯誤', 'danger');
                });
        }

        // 刪除記錄
        function deleteRecord(index) {
            if (!confirm('確定要刪除這筆記錄嗎？')) {
                return;
            }
            
            showLoading(true);
            
            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'delete', rowIndex: index })
            })
            .then(response => response.json())
            .then(result => {
                showLoading(false);
                if (result.status === 'success') {
                    showAlert('刪除成功！', 'success');
                    loadData();
                } else {
                    showAlert('刪除失敗：' + result.message, 'danger');
                }
            })
            .catch(error => {
                showLoading(false);
                console.error('Error:', error);
                showAlert('刪除時發生錯誤', 'danger');
            });
        }

        // 重置表單
        function resetForm() {
            document.getElementById('saleForm').reset();
            setDefaultDate();
            editMode = false;
            currentEditRow = null;
            
            document.getElementById('formTitle').textContent = '新增銷售記錄';
            document.getElementById('submitBtn').innerHTML = '<i class="bi bi-check-circle"></i> 儲存';
            document.getElementById('cancelBtn').style.display = 'none';
        }

        // 顯示/隱藏載入動畫
        function showLoading(show) {
            const spinner = document.getElementById('loadingSpinner');
            if (show) {
                spinner.classList.add('show');
            } else {
                spinner.classList.remove('show');
            }
        }

        // 顯示提示訊息
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
            alertDiv.style.zIndex = '10000';
            alertDiv.style.minWidth = '300px';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }

        // 格式化數字
        function formatNumber(num) {
            return new Intl.NumberFormat('zh-TW').format(num || 0);
        }

        // 跳脫 HTML 特殊字元
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
    </script>
</body>
</html>